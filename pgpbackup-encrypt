#!/bin/bash

#TODO: Documentation

progname="PGP-Backup"
libname="Encryption"
version="v0.2.0-alpha.3"

function encryptFile {
    local email=$1
    local file=$2
    local path=$3
    local hash=$4

    gpg -q --output "../backup/$path.gpg" --encrypt --recipient "$email" "$file"

    if [ $hash -eq 1 ]; then
        # Hash filename
        mv "../backup/$path.gpg" "$(dirname "../backup/$path.gpg")/$(echo "$email-$(basename "$path.gpg")" | shasum -a 256 | cut -f1 -d " ").gpg"
    fi
}

function checkFiles {
    local email=$1
    local path=$2
    local hiddenFiles=$3
    local hash=$4

    if [ $hiddenFiles -eq 0 ]; then
        local findOptions="! -path \"*/.*\"";
    else
        local findOptions="";
    fi

    findCommand="find \"$path\" -maxdepth 1"
    if [ $hiddenFiles -eq 0 ]; then
        findCommand+=" ! -path \"*/.*\"";
    fi
    findCommand+=" -type f $findOptions"

    eval $findCommand | while read i
    do
        if [ ! -f "../backup/$i.gpg" ] && [[ "$i" != *decrypt.sh ]] && [[ "$i" != *pgpbackup-decrypt ]]; then
            encryptFile "$email" "$i" "$i" $hash
        fi
    done
}

function handleDir {
    local depth=$1
    local email=$2
    local path=$3
    local hiddenFiles=$4
    local hash=$5

    # Create necessary folders
    if [ "$path" = "." ]; then
        mkdir "../backup"
        mkdir "../tmp"
        cp "decrypt.sh" "../backup/decrypt.sh"
        cp "pgpbackup-decrypt" "../backup/pgpbackup-decrypt" > /dev/null
    fi

    if [ $depth -eq 0 ]; then
        local oldPath=$PWD
        if [ "$path" = "." ]; then
            folderPath="."
            folderName="backup"
        else
            cd "$path"
            folderPath="$(dirname "$path")"
            folderName="$(basename "$path")"
        fi

        findCommand="find \".\" -maxdepth 1 ! -name \".\" ! -name \"decrypt.sh\" ! -name \"pgpbackup-decrypt\" $findOptions"
        if [ $hiddenFiles -eq 0 ]; then
            findCommand+="! -path \"*/.*\""
        fi

        eval $findCommand | while read i
        do
            zip -qur "$oldPath/../tmp/$folderPath/$folderName.pb.zip" "./$i"
        done
        cd "$oldPath"
        if [ "$path" == "." ]; then
            path=$folderName
        fi
        if [ -f "../tmp/$path.pb.zip" ]; then
            encryptFile "$email" "../tmp/$path.pb.zip" "$path" $hash
        fi
    else
        if [ "$path" != "." ]; then
            mkdir "../backup/$path"
            mkdir "../tmp/$path"
        fi

        # Handle files in directory
        checkFiles $email "$path" $hiddenFiles $hash

        # Handle directories in directory
        findCommand="find \"$path\" -maxdepth 1 $findOptions ! -path \"$path\""
        if [ $hiddenFiles -eq 0 ]; then
            findCommand+=" ! -path \"*/.*\""
        fi
        findCommand+=" -type d"

        eval $findCommand | while read i
        do
            if [ $depth -gt 0 ]; then
                handleDir $[$depth-1] $email "$i" $hiddenFiles $hash
            elif [ $depth -lt 0 ]; then
                handleDir $depth $email "$i" $hiddenFiles $hash
            fi
        done
    fi
}

# Check flags
depth=-1
hash=1
hiddenFiles=0
while getopts ":acd:hv" opt; do
    case $opt in
        a)
            hiddenFiles=1;;
        c)
            hash=0;;
        d)
            #TODO: check for int
            depth=$OPTARG;;
        h)
            echo "Usage: pgpbackup-encrypt [-a | -c | -d depth | -h | -v] email"
            exit 0;;
        v)
            echo $progname "-" $libname
            echo $version
            exit 0;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1;;
        :)
            echo "Option -$OPTARG requires an argument." >&2
            exit 1;;
    esac
done
shift $(($OPTIND - 1))

echo $progname $version "-" $libname

# Parameters
if [ $# -ne 1 ]; then
    echo "Please provide an email to encrypt for as argument."
    exit 1
fi
email=$1

handleDir $depth $email . $hiddenFiles $hash

if [ $hash -eq 1 ]; then
    # Hash folder names
    cd "../backup"
    find "." -mindepth 1 -depth -type d | while read j
    do
        path=$(dirname "$j")
        name=$(basename "$j")
        hashedName=$(echo "$email-$name" | shasum -a 256 | cut -f1 -d " ")
        echo "$hashedName;$name" > "$path/foldernames.txt"
        mv "$j" "$(dirname "$j")/$hashedName"
    done
    find "." -type f -iname "foldernames.txt" | while read j
    do
        encryptFile $email "$j" "$j" 0
        rm "$j"
    done
fi

# Tidy up
rm -r "../tmp"

echo "Finished encrypting!"
exit 0
